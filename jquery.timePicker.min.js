/*
 * A time picker for jQuery
 *
 * Dual licensed under the MIT and GPL licenses.
 * Copyright (c) 2009-2011 Anders Fajerson
 * @name     timePicker
 * @author   Anders Fajerson (http://perifer.se)
 * @example  $("#mytime").timePicker();
 * @example  $("#mytime").timePicker({step:30, startTime:new Date(0, 0, 0, 15, 00, 0), endTime:"18:00", timeFormat:"hh:mm tt"});
 *
 * Based on timePicker by Sam Collet (http://www.texotela.co.uk)
 *
 */
 
!function(p){function v(e,t,s){e.value=p(t).text(),p(e).change(),e.focus(),s.hide()}function H(e,t){if(e)return d(t,e)}function k(e,t){if("object"==typeof e)return(s=e).setFullYear(2001),s.setMonth(0),s.setDate(0),s;for(var s,r,i,n=t.timeFormat.match(/(hh?|HH?|mm?|ss?|tt?)/g),o=d(t,!1),a=new RegExp("^"+o+"$"),u=e.match(a),c=-1,f=-1,m=0,l=t.amDesignator,h=t.pmDesignator,g=0;g<n.length;g++)if(u&&u[g+1])switch(n[g]){case"hh":case"h":c=parseInt(u[g+1],10);break;case"HH":case"H":c=parseInt(u[g+1],10);break;case"mm":case"m":f=parseInt(u[g+1],10);break;case"ss":case"s":m=parseInt(u[g+1],10);break;case"t":l=l.substring(0,1),h=h.substring(0,1);case"tt":r=u[g+1]}if(12===c&&r===l?c=0:12!==c&&r===h&&(c+=12),(i=new Date(2001,0,0,c,f,m)).getHours()!=c||i.getMinutes()!=f||i.getSeconds()!=m)throw"Invalid time";return i}function d(r,i){function n(e){return e<10?"0"+e:e}return r.timeFormat.replace(/hh?|HH?|mm?|ss?|tt?/g,function(e){var t=r.amDesignator,s=r.pmDesignator;switch(e){case"hh":return i?n((i.getHours()+11)%12+1):"([0-1][0-9])";case"h":return i?(i.getHours()+11)%12+1:"([0-1]?[0-9])";case"HH":return i?n(i.getHours()):"([0-2][0-9])";case"H":return i?i.getHours():"([0-2]?[0-9])";case"mm":return i?n(i.getMinutes()):"([0-6][0-9])";case"m":return i?i.getMinutes():"([0-6]?[0-9])";case"ss":return i?n(i.getSeconds()):"([0-6][0-9])";case"s":return i?i.getSeconds():"([0-6]?[0-9])";case"t":return i?i.getHours()<12?t.substring(0,1):s.substring(0,1):"("+t.substring(0,1)+"|"+s.substring(0,1)+")";case"tt":return i?i.getHours()<12?t:s:"("+t+"|"+s+")"}return""})}p.fn.timePicker=function(e){var t;void 0===e||void 0===e.separator&&void 0===e.show24Hours||e.timeFormat||(t=void 0===e.show24Hours||e.show24Hours,e.timeFormat=(t?"HH":"hh")+(void 0!==e.separator?e.separator:":")+"mm"+(t?"":" tt"));var s=p.extend({},p.fn.timePicker.defaults,e);return this.each(function(){p.timePicker(this,s)})},p.timePicker=function(e,t){var s=p(e)[0];return s.timePicker||(s.timePicker=new jQuery._timePicker(s,t))},p.timePicker.version="0.4",p.timePicker.formatTime=function(e,t,s){return(s=s||p.fn.timePicker.defaults).timeFormat=e,H(t,s)},p.timePicker.parseTime=function(e,t,s){return(s=s||p.fn.timePicker.defaults).timeFormat=e,k(t,s)},p._timePicker=function(a,u){var e=!1,o=!1,c=k(u.startTime,u),f=k(u.endTime,u),m="selected",l="li."+m;p(a).attr("autocomplete","OFF");for(var t=[],s=new Date(c);s<=f;)t[t.length]=H(s,u),s=new Date(s.setMinutes(s.getMinutes()+u.step));for(var h=p('<div class="time-picker'+(u.show24Hours?"":" time-picker-12hours")+'"></div>'),g=p("<ul></ul>"),r=0;r<t.length;r++)g.append("<li>"+t[r]+"</li>");h.append(g),h.appendTo("body").hide(),h.mouseover(function(){e=!0}).mouseout(function(){e=!1}),p("li",g).mouseover(function(){o||(p(l,h).removeClass(m),p(this).addClass(m))}).mousedown(function(){e=!0}).click(function(){v(a,this,h),e=!1});function d(){if(h.is(":visible"))return!1;p("li",h).removeClass(m);var e=p(a).offset();h.css({top:e.top+a.offsetHeight,left:e.left}),h.show();var t=c;if(a.value)try{t=k(a.value,u);var s=60*c.getHours()+c.getMinutes(),r=60*t.getHours()+t.getMinutes()-s,i=Math.round(r/u.step),n=new Date(2001,0,0,0,i*u.step+s,0),t=c<n&&n<=f?n:c}catch(e){}var o=p("li:contains("+H(t,u)+")",h);return o.length&&(o.addClass(m),h[0].scrollTop=o[0].offsetTop),!0}p(a).focus(d).click(d),p(a).blur(function(){e||h.hide()});p(a).keydown(function(e){var t;o=!0;var s,r=h[0].scrollTop;switch(e.keyCode){case 38:if(d())return!1;var i=(t=p(l,g)).prev().addClass(m)[0];return i?(t.removeClass(m),i.offsetTop<r&&(h[0].scrollTop=r-i.offsetHeight)):(t.removeClass(m),i=p("li:last",g).addClass(m)[0],h[0].scrollTop=i.offsetTop-i.offsetHeight),!1;case 40:if(d())return!1;var n=(t=p(l,g)).next().addClass(m)[0];return n?(t.removeClass(m),n.offsetTop+n.offsetHeight>r+h[0].offsetHeight&&(h[0].scrollTop=r+n.offsetHeight)):(t.removeClass(m),n=p("li:first",g).addClass(m)[0],h[0].scrollTop=0),!1;case 13:return h.is(":visible")&&(s=p(l,g)[0],v(a,s,h)),!1;case 27:return h.hide(),!1}return!0}),p(a).keyup(function(e){o=!1}),this.getTime=function(){return k(a.value,u)},this.setTime=function(e){a.value=H(k(e,u),u),p(a).change()}},p.fn.timePicker.defaults={step:30,startTime:new Date(0,0,0,0,0,0),endTime:new Date(0,0,0,23,30,0),timeFormat:"HH:mm",amDesignator:"AM",pmDesignator:"PM"}}(jQuery);